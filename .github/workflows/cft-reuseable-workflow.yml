name: Deploy CloudFormation Resusable Workflow

on:
  workflow_call:
    inputs:
      stack_identifier:
        required: true
        type: string
      template_path:
        required: true
        type: string
      params-file:
        required: false
        type: string
      capabilities:
        required: false
        type: string
        default: CAPABILITY_NAMED_IAM

permissions:
  id-token: write
  contents: read

env:
  ENV_NAME: ${{ github.ref_type == 'tag' && 'production' || github.ref_name == 'development' && 'development' || github.ref_name == 'test' && 'test' || 'development' }}

jobs:
  security-scans:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4.1.7

    - name: cfn-lint-scan
      env:
        TEMPLATE_PATH: ${{ inputs.template_path }}
      run: |
        pip install cfn-lint --quiet
        cfn-lint --template "$TEMPLATE_PATH"

    - name: cfn-nag-scan
      uses: stelligent/cfn_nag@v0.8.10
      with:
        input_path: ${{ inputs.template_path }}
        extra_args: --parameter-values-path ./parameters/${{ env.ENV_NAME }}.json
      
    - name: Verify cfn_nag scan results
      run: |
        exit `grep Failures cfn_nag.out | awk '{ SUM += $3} END { print SUM }'`   

  create-cloudformation-change-set:
    runs-on: ubuntu-latest
    needs:  security-scans
    outputs:
      CFT_CHANGE_SET_ID: ${{ steps.create-cloudformation-changeset.outputs.CFT_CHANGE_SET_ID }} 

    steps:
    - name: checking out to repository
      uses: actions/checkout@v4.1.7

    - name: Configure AWS Credentials based on region.
      uses: aws-actions/configure-aws-credentials@v4.0.2
      with:
        aws-region: ${{ secrets.AWS_REGION }}
        role-to-assume: ${{ env.ENV_NAME == 'production' && secrets.PRODUCTION_DEPLOYMENT_ROLE || env.ENV_NAME == 'development' && secrets.DEVELOPMENT_DEPLOYMENT_ROLE || env.ENV_NAME == 'test' && secrets.TEST_DEPLOYMENT_ROLE }}

    - name: Create changeset for Cloudformation
      id: create-cloudformation-changeset
      env:
        TEMPLATE_PATH: ${{ inputs.template_path }}
        STACK_NAME: ${{ format('{0}-blog-{1}', env.ENV_NAME, inputs.stack_identifier) }}
        CAPABILITIES: ${{ inputs.capabilities }}
      run: |
        echo "===================="
        echo "Creating change-set version:-"
        echo "===================="
        DEPLOY_OUTPUT=$(aws cloudformation deploy --template-file "$TEMPLATE_PATH" --stack-name "$STACK_NAME" --parameter-overrides file://parameters/$ENV_NAME.json --tags file://parameters/tags.json --no-execute-changeset --capabilities "$CAPABILITIES" --output text 2>&1) || true
        echo $DEPLOY_OUTPUT
        if echo "$DEPLOY_OUTPUT" | grep -q "No changes to deploy"; then
          echo "No changes to deploy. Stack $STACK_NAME is up to date."
          echo "CFT_CHANGE_SET_ID=" >> $GITHUB_OUTPUT
        else
          CFT_CHANGE_SET_ID=$(aws cloudformation list-change-sets --stack-name "$STACK_NAME" --query 'max_by(Summaries[?ExecutionStatus==`AVAILABLE` && Status==`CREATE_COMPLETE`], &CreationTime).ChangeSetName' --output text)
          echo "CFT_CHANGE_SET_ID=$CFT_CHANGE_SET_ID" >> $GITHUB_OUTPUT
          echo $CFT_CHANGE_SET_ID
        fi
  
    - name: View cloudformation changeset
      if: ${{ steps.create-cloudformation-changeset.outputs.CFT_CHANGE_SET_ID != '' }}
      env:
        CHANGE_SET_ID: ${{ steps.create-cloudformation-changeset.outputs.CFT_CHANGE_SET_ID }}
        STACK_NAME: ${{ format('{0}-blog-{1}', env.ENV_NAME, inputs.stack_identifier) }}
      run: |
        echo "=== Printing latest change-set version !! ==="
        aws cloudformation describe-change-set --change-set-name "$CHANGE_SET_ID" --stack-name "$STACK_NAME" --output table

  cloudformation-stack-deploy:
    runs-on: ubuntu-latest
    needs: create-cloudformation-change-set
    steps:
    - name: checking out to repository-name
      uses: actions/checkout@v4.1.7

    - name: Configure AWS Credentials based on region.
      uses: aws-actions/configure-aws-credentials@v4.0.2
      with:
        aws-region: ${{ secrets.AWS_REGION }}
        role-to-assume: ${{ env.ENV_NAME == 'production' && secrets.PRODUCTION_DEPLOYMENT_ROLE || env.ENV_NAME == 'development' && secrets.DEVELOPMENT_DEPLOYMENT_ROLE || env.ENV_NAME == 'test' && secrets.TEST_DEPLOYMENT_ROLE }}

    - name: Create or Update CloudFormation stack
      if: ${{ needs.create-cloudformation-change-set.outputs.CFT_CHANGE_SET_ID != '' }}
      env:
        CHANGE_SET_ID: ${{ needs.create-cloudformation-change-set.outputs.CFT_CHANGE_SET_ID }}
        STACK_NAME: ${{ format('{0}-blog-{1}', env.ENV_NAME, inputs.stack_identifier) }}
        STACK_IDENTIFIER: ${{ inputs.stack_identifier }}
      run: |
        echo "Deploying change-set..."
        aws cloudformation execute-change-set --change-set-name "$CHANGE_SET_ID" --stack-name "$STACK_NAME" --output table
        echo "Change-set $CHANGE_SET_ID applied successfully on the stack $STACK_IDENTIFIER !!"
    
    - name: Verify stack deployment status
      if: ${{ needs.create-cloudformation-change-set.outputs.CFT_CHANGE_SET_ID != '' }}
      env:
        STACK_NAME: ${{ format('{0}-blog-{1}', env.ENV_NAME, inputs.stack_identifier) }}
      run: |
        echo "Waiting for stack operation to complete..."
        
        MAX_ATTEMPTS=20  
        WAIT_TIME=20     
        
        for ((i=1; i<=MAX_ATTEMPTS; i++)); do
          echo "Attempt $i/$MAX_ATTEMPTS - Checking status..."
          
          # Get stack status with better error handling
          STATUS=$(aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query 'Stacks[0].StackStatus' \
            --output text 2>&1)
          
          # Check if the command failed
          if [ $? -ne 0 ]; then
            if [[ "$STATUS" == *"does not exist"* ]]; then
              echo "Stack does not exist yet. Waiting..."
              sleep $WAIT_TIME
              continue
            else
              echo "Error retrieving stack status: $STATUS"
              exit 1
            fi
          fi
          
          echo "Current status: $STATUS"
          
          # Handle all possible status values
          case $STATUS in
            # Success states
            CREATE_COMPLETE|UPDATE_COMPLETE)
              echo "Stack deployment successful!"
              exit 0
              ;;
              
            # In-progress states - continue waiting
            CREATE_IN_PROGRESS|UPDATE_IN_PROGRESS|UPDATE_COMPLETE_CLEANUP_IN_PROGRESS)
              echo "Stack operation in progress. Waiting..."
              sleep $WAIT_TIME
              continue
              ;;
              
            # Rollback states that might still succeed
            ROLLBACK_IN_PROGRESS|UPDATE_ROLLBACK_IN_PROGRESS|UPDATE_ROLLBACK_COMPLETE_CLEANUP_IN_PROGRESS)
              echo "Stack performing rollback operations. Waiting..."
              sleep $WAIT_TIME
              continue
              ;;
              
            # Terminal failure states
            CREATE_FAILED|ROLLBACK_FAILED|DELETE_FAILED|UPDATE_ROLLBACK_FAILED)
              echo "Stack operation failed with terminal failure status: $STATUS"
              exit 1
              ;;
              
            # Rollback completed states (deployment failed but rollback succeeded)
            ROLLBACK_COMPLETE|UPDATE_ROLLBACK_COMPLETE)
              echo "Stack deployment failed but rollback completed successfully: $STATUS"
              exit 1
              ;;
              
            # Other unexpected states
            *)
              echo "Unexpected stack status: $STATUS"
              exit 1
              ;;
          esac
        done
        
        echo "Stack operation timed out after $MAX_ATTEMPTS attempts ($(($MAX_ATTEMPTS * $WAIT_TIME / 60)) minutes)"
        exit 1